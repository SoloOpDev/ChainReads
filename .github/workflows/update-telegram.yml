name: Update Telegram Data

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install telethon python-dotenv cryptg requests
          
      - name: Fetch Telegram data
        run: python3 fetch_telegram_enhanced.py
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
          TELEGRAM_TRADING_CHANNELS: ${{ secrets.TELEGRAM_TRADING_CHANNELS }}
          TELEGRAM_AIRDROP_CHANNELS: ${{ secrets.TELEGRAM_AIRDROP_CHANNELS }}
          IMAGEKIT_PRIVATE_KEY: ${{ secrets.IMAGEKIT_PRIVATE_KEY }}
          IMAGEKIT_URL_ENDPOINT: ${{ secrets.IMAGEKIT_URL_ENDPOINT }}
          
      - name: Send data to API
        run: |
          python3 << 'EOF'
          import json
          import os
          import requests
          import time
          
          # Check if file exists
          if not os.path.exists('telegram_posts.json'):
              print("âŒ telegram_posts.json not found!")
              print("Files in current directory:")
              print(os.listdir('.'))
              exit(1)
          
          with open('telegram_posts.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          posts = data.get('results', [])
          
          if not posts:
              print("âš ï¸ No posts to send")
              exit(0)
          
          # Images are now hosted on ImageKit CDN - no Railway redeployments needed!
          # ImageKit free tier: 20GB storage + 20GB bandwidth/month
          # With 30-day cleanup, stays within free tier forever
          
          # Send in batches of 100 posts
          BATCH_SIZE = 100
          total_batches = (len(posts) + BATCH_SIZE - 1) // BATCH_SIZE
          
          print(f"ðŸ“¤ Sending {len(posts)} posts in {total_batches} batches...")
          
          for i in range(0, len(posts), BATCH_SIZE):
              batch = posts[i:i + BATCH_SIZE]
              batch_num = (i // BATCH_SIZE) + 1
              
              payload = {
                  "secret": "${{ secrets.TELEGRAM_UPDATE_SECRET }}",
                  "posts": batch
              }
              
              print(f"\nðŸ“¦ Batch {batch_num}/{total_batches}: Sending {len(batch)} posts...")
              
              response = requests.post(
                  "${{ secrets.RAILWAY_API_URL }}/api/telegram/update",
                  json=payload,
                  headers={"Content-Type": "application/json"},
                  timeout=30
              )
              
              print(f"   Status: {response.status_code}")
              
              if response.status_code != 200:
                  print(f"   âŒ Error: {response.text}")
                  exit(1)
              else:
                  print(f"   âœ… Batch sent successfully")
              
              # Small delay between batches
              if i + BATCH_SIZE < len(posts):
                  time.sleep(1)
          
          print(f"\nâœ… All {len(posts)} posts sent successfully!")
          EOF
