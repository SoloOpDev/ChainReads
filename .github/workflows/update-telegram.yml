name: Update Telegram Data

on:
  schedule:
    - cron: '0 * * * *'  # Every 1 hour
  workflow_dispatch:  # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install telethon python-dotenv cryptg requests
          
      - name: Fetch Telegram data
        run: python3 fetch_telegram_enhanced.py
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
          TELEGRAM_TRADING_CHANNELS: ${{ secrets.TELEGRAM_TRADING_CHANNELS }}
          TELEGRAM_AIRDROP_CHANNELS: ${{ secrets.TELEGRAM_AIRDROP_CHANNELS }}
          
      - name: Send data to API with images
        run: |
          python3 << 'EOF'
          import json
          import base64
          import os
          import requests
          
          with open('telegram_posts.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          posts = data.get('results', [])
          
          for post in posts:
              if post.get('image'):
                  img_path = 'client/public' + post['image']
                  if os.path.exists(img_path):
                      with open(img_path, 'rb') as img:
                          post['imageData'] = base64.b64encode(img.read()).decode('utf-8')
          
          payload = {
              "secret": "${{ secrets.TELEGRAM_UPDATE_SECRET }}",
              "posts": posts
          }
          
          response = requests.post(
              "${{ secrets.RAILWAY_API_URL }}/api/telegram/update",
              json=payload,
              headers={"Content-Type": "application/json"}
          )
          
          print(f"Status: {response.status_code}")
          print(f"Response: {response.text}")
          
          if response.status_code != 200:
              exit(1)
          EOF
